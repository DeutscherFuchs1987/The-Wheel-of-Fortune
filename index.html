<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã üé°</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1a1e2f 0%, #2a2f44 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #eaeef2;
        }

        .app {
            max-width: 1300px;
            width: 100%;
            background: rgba(18, 22, 36, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 48px;
            padding: 30px;
            box-shadow: 0 25px 50px -8px rgba(0, 0, 0, 0.6), inset 0 2px 4px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.07);
        }

        h1 {
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 500;
            font-size: 2.2rem;
            letter-spacing: 1px;
            background: linear-gradient(120deg, #a7c0e7, #d6b0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .filter-badge {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 25px;
        }

        .filter-badge button {
            background: #262d4a;
            border: none;
            color: #cbd5ff;
            padding: 10px 24px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid #48537e;
            box-shadow: 0 5px 0 #13182b;
        }

        .filter-badge button.active {
            background: #5f4bb6;
            color: white;
            border-color: #a990ff;
            box-shadow: 0 5px 0 #352b66;
        }

        .controls-panel {
            background: #1a1f33;
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            border: 1px solid #3d435b;
        }

        .slider-control {
            flex: 1;
            min-width: 200px;
        }

        .slider-control label {
            display: flex;
            justify-content: space-between;
            color: #a3b7f0;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .slider-control input {
            width: 100%;
            height: 6px;
            background: #2f3a6b;
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #ffd966;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #ffaa00;
            border: 2px solid white;
        }

        .slider-value {
            background: #2f3a6b;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.9rem;
            color: #ffd966;
        }

        .wheel-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 30px;
            margin: 30px 0;
        }

        .canvas-wrapper {
            flex: 2;
            min-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .pointer {
            position: relative;
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-top: 50px solid #ffd966;
            filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.5));
            margin-bottom: -25px;
            z-index: 10;
            top: 15px;
        }

        .pointer::after {
            content: '';
            position: absolute;
            top: -55px;
            left: -10px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffaa00, #ffd966);
            border-radius: 50%;
            box-shadow: 0 0 20px #ffaa00;
        }

        .pointer-glow {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
            top: -20px;
            left: -25px;
            z-index: 5;
            pointer-events: none;
        }

        canvas {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            background: #191e30;
            border-radius: 50%;
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.7), 0 0 0 2px #565b82 inset;
            position: relative;
            z-index: 1;
        }

        .wheel-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin: 25px 0 10px;
        }

        .wheel-controls button {
            background: #283153;
            border: none;
            color: white;
            padding: 14px 22px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 4px solid #0e142b;
            transition: 0.1s linear;
            box-shadow: 0 7px 0 #0b0f20;
        }

        .wheel-controls button:active {
            border-bottom-width: 1px;
            transform: translateY(5px);
            box-shadow: 0 2px 0 #0b0f20;
        }

        .wheel-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .eliminate-mode {
            background: #442c5c !important;
            border-bottom-color: #281b38 !important;
        }

        .result-area {
            flex: 1;
            min-width: 260px;
            background: #191f33dd;
            border-radius: 48px;
            padding: 25px;
            backdrop-filter: blur(4px);
            border: 1px solid #50587e;
            box-shadow: inset 0 0 15px #00000055;
        }

        .result-title {
            font-size: 1.3rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 300;
            color: #a3b7f0;
        }

        .result-name {
            font-size: 2.5rem;
            line-height: 1.3;
            font-weight: 700;
            word-break: break-word;
            background: linear-gradient(135deg, #ffe69b, #ffb3b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            min-height: 100px;
        }

        .elim-list {
            margin-top: 20px;
            max-height: 220px;
            overflow-y: auto;
            padding-right: 10px;
            font-size: 0.95rem;
            color: #b7c2ea;
        }

        .elim-list span {
            display: block;
            padding: 5px 0;
            border-bottom: 1px dashed #414b70;
        }

        .items-pool {
            margin-top: 25px;
            background: #0c102080;
            border-radius: 32px;
            padding: 16px 20px;
        }

        .items-pool h3 {
            font-weight: 400;
            margin: 0 0 15px 0;
            color: #c1cdff;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .item-count {
            background: #2f3a6b;
            padding: 2px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
        }

        .pool-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .tag {
            background: #303a60;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            border: 1px solid #6c79b0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .tag:hover {
            background: #3f4b7a;
            transform: translateY(-2px);
        }

        .delete-item {
            width: 20px;
            height: 20px;
            background: #ff6b8b;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s;
            border: 1px solid #ffd966;
        }

        .delete-item:hover {
            background: #ff4757;
            transform: scale(1.2);
        }

        .footer-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }

        .manual-add {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .manual-add input {
            background: #010214;
            border: 1px solid #49537c;
            border-radius: 60px;
            padding: 12px 24px;
            font-size: 1rem;
            color: white;
            width: 240px;
            outline: none;
        }

        .manual-add input::placeholder {
            color: #6b729b;
        }

        .manual-add button {
            background: #283153;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 4px solid #0e142b;
        }

        .clear-btn {
            background: #371f2f !important;
            border-bottom-color: #21131e !important;
        }

        .json-upload {
            margin-top: 20px;
            padding: 20px;
            background: #1a1f33;
            border-radius: 30px;
            border: 1px dashed #5f6a9e;
        }

        .json-btn {
            background: #4a3f6e;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 15px;
            border-bottom: 4px solid #2a2342;
        }

        .json-btn:active {
            border-bottom-width: 1px;
            transform: translateY(3px);
        }

        .error-message {
            color: #ff8a8a;
            background: #3d1e2b;
            padding: 12px 20px;
            border-radius: 40px;
            margin-top: 15px;
            display: none;
        }

        .success-message {
            color: #a0ffa0;
            background: #1e3a2a;
            padding: 10px 20px;
            border-radius: 40px;
            margin-top: 10px;
            display: none;
        }

        .spin-indicator {
            margin-top: 10px;
            color: #a3b7f0;
            font-size: 0.9rem;
            height: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: #283153;
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 600;
            border-bottom: 4px solid #0e142b;
            transition: 0.1s linear;
        }

        .nav-btn.active {
            background: #5f4bb6;
            border-bottom-color: #352b66;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .controls-panel {
            background: #1a1f33;
            border-radius: 40px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #3d435b;
        }
    </style>
</head>

<body>
    <div class="app">

        <div class="header">
            <h1>üé° –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´</h1>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn active">üé° –ö–æ–ª–µ—Å–æ</a>
                <a href="catalog.html" class="nav-btn ">üìö –ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="ratings.html" class="nav-btn active">‚≠ê –û—Ü–µ–Ω–∫–∏</a>
            </div>
        </div>


        <div class="filter-badge" id="filter-buttons"></div>
        <div class="success-message" id="successMessage"></div>

        <!-- –ü–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="controls-panel">
            <div class="slider-control">
                <label>
                    <span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è</span>
                    <span class="slider-value" id="speedValue">2.0 —Å–µ–∫</span>
                </label>
                <input type="range" id="speedSlider" min="0.5" max="4.0" step="0.1" value="2.0">
            </div>
            <div class="slider-control">
                <label>
                    <span>üîÑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä–æ—Ç–æ–≤</span>
                    <span class="slider-value" id="rotationsValue">8</span>
                </label>
                <input type="range" id="rotationsSlider" min="3" max="15" step="1" value="8">
            </div>
        </div>

        <div class="wheel-container">
            <div class="canvas-wrapper">
                <div class="pointer">
                    <div class="pointer-glow"></div>
                </div>
                <canvas id="wheelCanvas" width="600" height="600"></canvas>
                <div class="wheel-controls">
                    <button id="spinOnceBtn">üé≤ –ö—Ä—É—Ç–∏—Ç—å (–æ–¥–∏–Ω –≤—ã–±–æ—Ä)</button>
                    <button id="spinEliminateBtn" class="eliminate-mode">‚öîÔ∏è –†–µ–∂–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è</button>
                    <button id="resetWheelBtn">‚ü≤ –°–±—Ä–æ—Å –∫–æ–ª–µ—Å–∞</button>
                </div>
                <div class="spin-indicator" id="spinIndicator"></div>
            </div>
            <div class="result-area">
                <div class="result-title">–ü–û–ë–ï–î–ò–¢–ï–õ–¨</div>
                <div class="result-name" id="winnerName">‚Äî</div>
                <div id="eliminatedContainer" class="elim-list"></div>
            </div>
        </div>

        <div class="items-pool">
            <h3>üìã –¢–µ–∫—É—â–∏–µ –ø—É–Ω–∫—Ç—ã <span class="item-count" id="itemCount">0</span></h3>
            <div class="pool-tags" id="itemPool"></div>
        </div>

        <div class="footer-actions">
            <div class="manual-add">
                <input type="text" id="manualInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
                <button id="addManualBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button id="clearAllBtn" class="clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>

        <div class="json-upload">
            <h3 style="margin-top:0; color:#c1cdff;">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ JSON</h3>
            <button id="jsonFileBtn" class="json-btn">üìÇ –í—ã–±—Ä–∞—Ç—å JSON —Ñ–∞–π–ª</button>
            <input type="file" id="jsonFileInput" accept="application/json" style="display:none;">
            <span id="fileName" style="color:#8891b5; margin-left:10px;"></span>
        </div>

        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        (function () {
            let allItems = [];
            let wheelItems = [];
            let eliminatedLog = [];
            let currentCategory = '–í—Å–µ';
            let isSpinning = false;

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è
            let spinSpeed = 2.0;
            let spinRotations = 8;

            const colorPalette = [
                '#FF6B8B', '#5F9EA0', '#FFD166', '#B185DB', '#FFB347', '#6A8D92', '#E5989B',
                '#6D6875', '#FF9AA2', '#B5838D', '#7B9C9E', '#F4A261', '#A7C4B5', '#CD9777',
                '#C44569', '#4A8FE4', '#E59866', '#A27E8E', '#82A7A6', '#FFC4D6'
            ];

            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const filterDiv = document.getElementById('filter-buttons');
            const winnerNameDiv = document.getElementById('winnerName');
            const eliminatedDiv = document.getElementById('eliminatedContainer');
            const itemPoolDiv = document.getElementById('itemPool');
            const itemCountSpan = document.getElementById('itemCount');
            const errorMessageDiv = document.getElementById('errorMessage');
            const successMessageDiv = document.getElementById('successMessage');
            const spinIndicator = document.getElementById('spinIndicator');
            const fileNameSpan = document.getElementById('fileName');

            const spinOnceBtn = document.getElementById('spinOnceBtn');
            const spinEliminateBtn = document.getElementById('spinEliminateBtn');
            const resetWheelBtn = document.getElementById('resetWheelBtn');
            const addManualBtn = document.getElementById('addManualBtn');
            const manualInput = document.getElementById('manualInput');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const jsonFileBtn = document.getElementById('jsonFileBtn');
            const jsonFileInput = document.getElementById('jsonFileInput');

            // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª–∑—É–Ω–∫–æ–≤
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            const rotationsSlider = document.getElementById('rotationsSlider');
            const rotationsValue = document.getElementById('rotationsValue');

            // ========== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ ==========
            function loadProjectsFromCatalog() {
                const saved = localStorage.getItem('myProjects');
                if (saved) {
                    try {
                        const projects = JSON.parse(saved);
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–æ–ª–µ—Å–∞
                        allItems = projects.map(p => ({
                            –ù–∞–∑–≤–∞–Ω–∏–µ: p.title_ru || p.title,
                            –ñ–∞–Ω—Ä: p.type || '–§–∏–ª—å–º'
                        }));
                        showSuccess(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞`);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                        allItems = [];
                    }
                } else {
                    // –ï—Å–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–µ—Å–∞
                    const savedWheel = localStorage.getItem('wheelItems');
                    if (savedWheel) {
                        try {
                            allItems = JSON.parse(savedWheel);
                        } catch (e) {
                            allItems = [];
                        }
                    } else {
                        allItems = [];
                    }
                }

                updateFilters();
                syncWheel();
            }

            // ========== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ localStorage ==========
            function saveWheelItems() {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–µ–±—è (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ –µ—â—ë –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
                localStorage.setItem('wheelItems', JSON.stringify(allItems));

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                const catalogProjects = allItems.map(item => ({
                    id: 'manual_' + Date.now() + Math.random(),
                    title: item.–ù–∞–∑–≤–∞–Ω–∏–µ,
                    title_ru: item.–ù–∞–∑–≤–∞–Ω–∏–µ,
                    year: '‚Äî',
                    rating: '‚Äî',
                    poster: null,
                    type: item.–ñ–∞–Ω—Ä || '–†–∞–∑–Ω–æ–µ'
                }));

                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                const existing = localStorage.getItem('myProjects');
                let merged = [];
                if (existing) {
                    try {
                        const existingProjects = JSON.parse(existing);
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)
                        const existingTitles = new Set(existingProjects.map(p => p.title));
                        const newProjects = catalogProjects.filter(p => !existingTitles.has(p.title));
                        merged = [...existingProjects, ...newProjects];
                    } catch (e) {
                        merged = catalogProjects;
                    }
                } else {
                    merged = catalogProjects;
                }

                localStorage.setItem('myProjects', JSON.stringify(merged));
                // –°–∏–≥–Ω–∞–ª –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
                localStorage.setItem('projectsUpdated', Date.now().toString());
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–∑—É–Ω–∫–æ–≤
            speedSlider.addEventListener('input', () => {
                spinSpeed = parseFloat(speedSlider.value);
                speedValue.textContent = spinSpeed.toFixed(1) + ' —Å–µ–∫';
            });

            rotationsSlider.addEventListener('input', () => {
                spinRotations = parseInt(rotationsSlider.value);
                rotationsValue.textContent = spinRotations;
            });

            function showError(text) {
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.textContent = '‚ùå ' + text;
                setTimeout(() => {
                    errorMessageDiv.style.display = 'none';
                }, 3000);
            }

            function showSuccess(text) {
                successMessageDiv.style.display = 'block';
                successMessageDiv.textContent = '‚úÖ ' + text;
                setTimeout(() => {
                    successMessageDiv.style.display = 'none';
                }, 2000);
            }

            function updateFilters() {
                const genres = extractGenres();
                filterDiv.innerHTML = '';

                const allBtn = document.createElement('button');
                allBtn.textContent = '–í—Å–µ';
                allBtn.dataset.filter = '–í—Å–µ';
                if (currentCategory === '–í—Å–µ') allBtn.classList.add('active');
                allBtn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-badge button').forEach(b => b.classList.remove('active'));
                    allBtn.classList.add('active');
                    currentCategory = '–í—Å–µ';
                    syncWheel();
                });
                filterDiv.appendChild(allBtn);

                genres.forEach(genre => {
                    const btn = document.createElement('button');
                    btn.textContent = genre;
                    btn.dataset.filter = genre;
                    if (currentCategory === genre) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.filter-badge button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentCategory = genre;
                        syncWheel();
                    });
                    filterDiv.appendChild(btn);
                });
            }

            function extractGenres() {
                const genres = new Set();
                allItems.forEach(item => {
                    if (item.–ñ–∞–Ω—Ä) genres.add(item.–ñ–∞–Ω—Ä);
                });
                return Array.from(genres).sort();
            }

            function getCurrentItems() {
                if (currentCategory === '–í—Å–µ') {
                    return allItems.map(item => item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                } else {
                    return allItems
                        .filter(item => item.–ñ–∞–Ω—Ä === currentCategory)
                        .map(item => item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                }
            }

            function syncWheel() {
                wheelItems = getCurrentItems();
                eliminatedLog = [];
                winnerNameDiv.textContent = '‚Äî';
                drawWheel();
                updatePoolView();
                updateEliminatedView();
            }

            function drawWheel(rotateAngle = 0) {
                const count = wheelItems.length;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (count === 0) {
                    ctx.beginPath();
                    ctx.arc(300, 300, 280, 0, 2 * Math.PI);
                    ctx.fillStyle = '#262d4a';
                    ctx.fill();
                    ctx.strokeStyle = '#5f6a9e';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    ctx.fillStyle = '#b5c2ff';
                    ctx.font = 'bold 22px Segoe UI';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 300, 300);
                    return;
                }

                const angleStep = (Math.PI * 2) / count;
                const radius = 280;
                const centerX = 300, centerY = 300;

                for (let i = 0; i < count; i++) {
                    const startAngle = i * angleStep + rotateAngle;
                    const endAngle = startAngle + angleStep;
                    const color = colorPalette[i % colorPalette.length];

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = '#0b0e1a';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();

                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(startAngle + angleStep / 2);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = '#121212';
                    ctx.font = 'bold 16px "Segoe UI", sans-serif';
                    ctx.shadowColor = 'rgba(255,255,255,0.5)';
                    ctx.shadowBlur = 4;

                    let text = wheelItems[i];
                    if (text.length > 20) text = text.substr(0, 18) + '‚Ä¶';
                    ctx.fillText(text, radius - 24, 8);
                    ctx.restore();
                }

                ctx.beginPath();
                ctx.arc(centerX, centerY, 18, 0, 2 * Math.PI);
                ctx.fillStyle = '#f2e9c0';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;

                ctx.beginPath();
                ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
                ctx.fillStyle = '#d4af37';
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(centerX, centerY - radius - 10);
                ctx.lineTo(centerX - 10, centerY - radius + 20);
                ctx.lineTo(centerX + 10, centerY - radius + 20);
                ctx.closePath();
                ctx.fillStyle = '#ffd700';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            function updatePoolView() {
                itemPoolDiv.innerHTML = '';
                if (wheelItems.length === 0) {
                    itemPoolDiv.innerHTML = '<span class="tag">‚ùå –ø—É—Å—Ç–æ</span>';
                    itemCountSpan.textContent = '0';
                    return;
                }

                wheelItems.forEach((item) => {
                    const container = document.createElement('span');
                    container.className = 'tag';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = item;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-item';
                    deleteBtn.innerHTML = '‚úï';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteItem(item);
                    });

                    container.appendChild(nameSpan);
                    container.appendChild(deleteBtn);
                    itemPoolDiv.appendChild(container);
                });

                itemCountSpan.textContent = wheelItems.length;
            }

            function deleteItem(itemName) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ allItems
                const itemIndex = allItems.findIndex(item => item.–ù–∞–∑–≤–∞–Ω–∏–µ === itemName);
                if (itemIndex !== -1) {
                    allItems.splice(itemIndex, 1);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    saveWheelItems();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∫–æ–ª–µ—Å–æ
                updateFilters();
                syncWheel();
                showSuccess(`–£–¥–∞–ª–µ–Ω–æ: ${itemName}`);
            }

            function updateEliminatedView() {
                if (eliminatedLog.length === 0) {
                    eliminatedDiv.innerHTML = '<span>‚úñÔ∏è –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ</span>';
                    return;
                }
                eliminatedDiv.innerHTML = eliminatedLog.map((name, idx) => `<span>‚ùå ${idx + 1}. ${name}</span>`).join('');
            }

            function spinAnimation(onComplete) {
                if (wheelItems.length === 0) {
                    showError('–î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –∫–æ–ª–µ—Å–æ');
                    return;
                }

                isSpinning = true;
                spinOnceBtn.disabled = true;
                spinEliminateBtn.disabled = true;

                const startTime = performance.now();
                const duration = spinSpeed * 1000;
                const startAngle = 0;

                const targetIndex = Math.floor(Math.random() * wheelItems.length);

                const pointerAngle = (3 * Math.PI) / 2;
                const segmentSize = (2 * Math.PI) / wheelItems.length;

                const targetStartAngle = pointerAngle - (targetIndex * segmentSize) - segmentSize / 2;
                const finalAngle = targetStartAngle - (spinRotations * 2 * Math.PI);

                function animate(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentAngle = startAngle + (finalAngle * easeOut);

                    drawWheel(currentAngle);
                    spinIndicator.textContent = `‚ö° –í—Ä–∞—â–µ–Ω–∏–µ... ${Math.round(progress * 100)}%`;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        isSpinning = false;
                        spinOnceBtn.disabled = false;
                        spinEliminateBtn.disabled = false;
                        spinIndicator.textContent = '';

                        const selected = wheelItems[targetIndex];
                        winnerNameDiv.textContent = selected;

                        const tags = document.querySelectorAll('.tag');
                        tags.forEach(tag => {
                            if (tag.textContent.includes(selected)) {
                                tag.style.background = '#5f4bb6';
                                tag.style.boxShadow = '0 0 15px #a990ff';
                                setTimeout(() => {
                                    tag.style.background = '';
                                    tag.style.boxShadow = '';
                                }, 1000);
                            }
                        });

                        if (onComplete) {
                            onComplete(selected, targetIndex);
                        }
                    }
                }

                requestAnimationFrame(animate);
            }

            function spinOnce() {
                spinAnimation();
            }

            function spinElimination() {
                if (wheelItems.length === 0) {
                    showError('–ö–æ–ª–µ—Å–æ –ø—É—Å—Ç–æ–µ');
                    return;
                }
                if (wheelItems.length === 1) {
                    winnerNameDiv.textContent = wheelItems[0] + ' üèÜ';
                    return;
                }

                spinAnimation((selected, index) => {
                    const removed = wheelItems.splice(index, 1)[0];
                    eliminatedLog.push(removed);
                    updateEliminatedView();
                    drawWheel();
                    updatePoolView();
                });
            }

            function loadFromJsonFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);

                        let items = [];

                        if (data.–õ–∏—Å—Ç1) {
                            items = Object.values(data.–õ–∏—Å—Ç1).filter(item => item && item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                        } else if (Array.isArray(data)) {
                            items = data.filter(item => item && item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                        } else {
                            for (let key in data) {
                                if (Array.isArray(data[key]) && data[key].length > 0 && data[key][0]?.–ù–∞–∑–≤–∞–Ω–∏–µ) {
                                    items = data[key].filter(item => item && item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                                    break;
                                }
                            }
                            if (items.length === 0) {
                                items = Object.values(data).filter(item => item && item.–ù–∞–∑–≤–∞–Ω–∏–µ);
                            }
                        }

                        if (items.length === 0) {
                            throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø–æ–ª–µ–º "–ù–∞–∑–≤–∞–Ω–∏–µ"');
                        }

                        allItems = items;
                        fileNameSpan.textContent = `üìÑ ${file.name}`;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        saveWheelItems();

                        showSuccess(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${items.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);

                        updateFilters();
                        syncWheel();

                    } catch (error) {
                        showError('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            // ========== –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ ==========
            window.addEventListener('storage', (e) => {
                if (e.key === 'myProjects' || e.key === 'projectsUpdated') {
                    loadProjectsFromCatalog();
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            spinOnceBtn.addEventListener('click', spinOnce);
            spinEliminateBtn.addEventListener('click', spinElimination);
            resetWheelBtn.addEventListener('click', syncWheel);

            addManualBtn.addEventListener('click', () => {
                const val = manualInput.value.trim();
                if (val === '') return;

                const newItem = {
                    –ù–∞–∑–≤–∞–Ω–∏–µ: val,
                    –ñ–∞–Ω—Ä: '–†–∞–∑–Ω–æ–µ'
                };

                allItems.push(newItem);
                manualInput.value = '';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveWheelItems();

                updateFilters();
                syncWheel();
                showSuccess('–î–æ–±–∞–≤–ª–µ–Ω–æ: ' + val);
            });

            clearAllBtn.addEventListener('click', () => {
                allItems = [];
                wheelItems = [];
                eliminatedLog = [];
                currentCategory = '–í—Å–µ';
                winnerNameDiv.textContent = '‚Äî';
                fileNameSpan.textContent = '';

                // –û—á–∏—â–∞–µ–º localStorage
                localStorage.removeItem('myProjects');
                localStorage.removeItem('wheelItems');
                localStorage.setItem('projectsUpdated', Date.now().toString());

                updateFilters();
                drawWheel();
                updatePoolView();
                updateEliminatedView();
            });

            jsonFileBtn.addEventListener('click', () => {
                jsonFileInput.click();
            });

            jsonFileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    loadFromJsonFile(e.target.files[0]);
                }
            });

            // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadProjectsFromCatalog();

            drawWheel();
            updatePoolView();
            updateEliminatedView();
        })();
    </script>
</body>

</html>